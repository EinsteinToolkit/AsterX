# Choose an agent virtual image
pool:
  vmImage: ubuntu-16.04
container:
  image: eschnett/cactus-amrex

steps:
- script: |
    set -euxo pipefail
    wget https://raw.githubusercontent.com/gridaphobe/CRL/ET_2019_03/GetComponents
    chmod a+x GetComponents
    ./GetComponents --parallel cactusamrex/azure-pipelines/amrex.th
    echo 'docker' >$HOME/.hostname
    cp cactusamrex/azure-pipelines/defs.local.ini Cactus/simfactory/etc
    cp cactusamrex/azure-pipelines/docker.ini Cactus/simfactory/mdb/machines
    cp cactusamrex/azure-pipelines/ubuntu.cfg Cactus/simfactory/mdb/optionlists
    cp cactusamrex/azure-pipelines/docker.sub Cactus/simfactory/mdb/submitscripts
    cp cactusamrex/azure-pipelines/docker.run Cactus/simfactory/mdb/runscripts
  displayName: Download Cactus
- script: |
    set -euxo pipefail
    cd Cactus
    ./simfactory/bin/sim build -j2 --thornlist=../cactusamrex/azure-pipelines/amrex.th
  displayName: Build Cactus
